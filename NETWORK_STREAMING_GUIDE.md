# 网络视频流传输详细指南

本文档详细说明如何通过以太网从ZynqMP开发板传输视频到PC。

---

## 目录

1. [系统架构](#系统架构)
2. [硬件准备](#硬件准备)
3. [软件依赖](#软件依赖)
4. [完整操作流程](#完整操作流程)
5. [常见问题排查](#常见问题排查)

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        ZynqMP 开发板                                 │
│                                                                     │
│  ┌──────────┐                      ┌──────────┐    ┌───────────────┐  │
│  │ Camera   │─────────────────────▶│  VDMA    │───▶│ eth-camera-app │  │
│  │ (PL端)   │  (YUV422->AXIS32)    │(写入DDR) │    │  (PS端)       │  │
│  └──────────┘                      └──────────┘    └───────┬───────┘  │
│                                                          │          │
│                                                          ▼          │
│                                                    ┌──────────┐     │
│                                                    │ 网口 ETH │     │
│                                                    └────┬─────┘     │
└─────────────────────────────────────────────────────────┼───────────┘
                                                          │
                                            UDP/TCP 网络传输
                                                          │
┌─────────────────────────────────────────────────────────┼───────────┐
│                          PC 电脑                         │           │
│                                                          ▼           │
│                                                    ┌──────────┐      │
│                                                    │ 网口 ETH │      │
│                                                    └────┬─────┘      │
│                                                         │            │
│  ┌───────────────────┐    ┌─────────────┐    ┌─────────▼─────────┐  │
│  │ 显示器/保存文件    │◀───│  OpenCV     │◀───│ receive_stream.py │  │
│  │                   │    │ (图像显示)   │    │   (Python接收)    │  │
│  └───────────────────┘    └─────────────┘    └───────────────────┘  │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 硬件准备

### 必需设备

| 设备 | 说明 |
|------|------|
| ZynqMP开发板 | 带有网口的Zynq UltraScale+ MPSoC开发板 |
| PC电脑 | Windows/Linux/Mac，带网口 |
| 网线 | 普通网线或交叉网线均可 |
| 相机模块 | 已连接到开发板PL端的相机 |

### 网络连接方式

**方式1：通过路由器连接（推荐）**
```
开发板 ──网线──▶ 路由器 ◀──网线── PC
```

**方式2：直连**
```
开发板 ──网线──▶ PC
```
> 直连时需要手动配置两端IP地址

---

## 软件依赖

### PC端（必须安装）

```bash
# 安装Python依赖
pip install opencv-python numpy

# 或使用pip3
pip3 install opencv-python numpy
```

**验证安装：**
```bash
python -c "import cv2; import numpy; print('安装成功！OpenCV版本:', cv2.__version__)"
```

### ZynqMP开发板端

**不需要安装OpenCV！** 网络传输程序是纯C代码，只依赖：
- 标准C库
- Linux socket API
- VDMA控制库（项目自带）

**PetaLinux配置要求：**
- 不需要勾选OpenCV
- 确保网络功能正常（能ping通）

---

## 完整操作流程

### 📋 操作流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                      开始                                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 步骤1: 硬件连接                                                   │
│   • 连接网线                                                      │
│   • 开发板上电                                                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 步骤2: 配置网络IP                                                 │
│   • 开发板设置IP                                                  │
│   • PC设置IP（如果需要）                                          │
│   • 互相ping测试                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 步骤3: 编译程序（仅首次需要）                                      │
│   • 在开发板上编译network-stream-app                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 步骤4: 【先】在PC端启动接收程序                                    │
│   $ python receive_stream.py -p 5000                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 步骤5: 【后】在开发板上启动发送程序                                 │
│   $ sudo ./run_network_stream.sh <PC的IP地址>                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 步骤6: 查看视频                                                   │
│   • PC端弹出视频窗口                                              │
│   • 按'q'键退出                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

### 步骤1：硬件连接

1. 使用网线连接开发板和PC（直连或通过路由器）
2. 给开发板上电
3. 确保相机模块已正确连接

---

### 步骤2：配置网络

#### 2.1 查看PC的IP地址

**Windows:**
```cmd
ipconfig
```
找到"以太网适配器"下的"IPv4 地址"，例如：`10.72.43.200`

**Linux/Mac:**
```bash
ifconfig
# 或
ip addr
```

#### 2.2 配置开发板IP

通过串口终端连接开发板，执行：

```bash
# 查看当前网络状态
ifconfig eth0

# 配置开发板IP（与PC在同一网段）
ifconfig eth0 10.72.43.10 netmask 255.255.0.0 up
```

#### 2.3 测试网络连通性

**在开发板上ping PC：**
```bash
ping 10.72.43.200 -c 3
```

**在PC上ping开发板：**
```bash
ping 10.72.43.10
```

✅ 如果能ping通，继续下一步
❌ 如果ping不通，请检查：
- 网线连接是否正常
- IP地址是否在同一网段
- 防火墙设置

---

### 步骤3：编译程序（仅首次需要）

在开发板上执行：

```bash
# 进入源码目录
cd /path/to/petalinux_app

# 编译网络传输程序
make network

# 编译完成后会生成 network-stream-app 文件
ls -la network-stream-app
```

**如果是交叉编译：**

在PC的PetaLinux SDK环境中：
```bash
# 设置SDK环境
source /opt/petalinux/2023.1/environment-setup-aarch64-xilinx-linux

# 编译
cd petalinux_app
make network

# 将编译好的程序复制到开发板
scp network-stream-app root@10.72.43.10:/usr/bin/
```

---

### 步骤4：在PC端启动接收程序（⚠️ 必须先启动！）

打开命令行/终端，执行：

```bash
# 进入项目目录
cd /path/to/workspace

# 运行接收程序
python receive_stream.py -p 5000
```

**看到以下输出表示成功：**
```
==================================================
网络视频流接收程序
==================================================
协议: UDP
端口: 5000
输出: 无
OpenCV: 已安装
==================================================

创建UDP服务器，监听端口: 5000
等待数据...

开始接收视频流...
按 'q' 键退出
```

**其他启动选项：**
```bash
# UDP模式（默认，低延迟）
python receive_stream.py -p 5000

# TCP模式（可靠传输）
python receive_stream.py -p 5000 -t

# 保存视频到文件
python receive_stream.py -p 5000 -o output.avi
```

---

### 步骤5：在开发板上启动发送程序

在开发板终端执行：

```bash
# 使用启动脚本（推荐）
sudo ./run_network_stream.sh 10.72.43.200

# 或直接运行程序
sudo ./eth-camera-app -H 10.72.43.200 -p 5000
```

**看到以下输出表示成功：**
```
========================================
网络视频流传输应用
Xilinx Zynq UltraScale+ MPSoC
CameraLink YUV422 over Ethernet
========================================

[1/4] 初始化VDMA...
[2/4] 启动VDMA...
[3/4] 初始化网络连接...
创建UDP套接字，目标: 10.72.43.200:5000

开始网络视频流传输...
分辨率: 640x480@60fps (YUV422/YUYV)
协议: UDP, 目标: 10.72.43.200:5000
已发送 60 帧 (FPS: 60.1, 码率: 295.1 Mbps)
已发送 120 帧 (FPS: 60.0, 码率: 294.9 Mbps)
...
```

---

### 步骤6：查看视频

- PC端会弹出一个名为 "Video Stream" 的窗口，显示实时视频
- 终端会显示统计信息：帧数、FPS、码率、丢帧数
- 按 **'q'** 键退出程序

---

## 命令参数速查

### PC端 receive_stream.py

| 参数 | 说明 | 示例 |
|------|------|------|
| `-p, --port` | 监听端口 | `-p 5000` |
| `-t, --tcp` | 使用TCP模式 | `-t` |
| `-o, --output` | 保存为视频文件 | `-o video.avi` |
| `-c, --color` | 解码模式（默认auto=优先YUV422） | `-c auto` / `-c uyvy` |
| `--yuv-order` | YUV422字节序 | `--yuv-order yuyv` |

### 开发板 eth-camera-app

| 参数 | 说明 | 示例 |
|------|------|------|
| `-H, --host` | PC的IP地址 | `-H 10.72.43.200` |
| `-p, --port` | 端口号 | `-p 5000` |
| `-t, --tcp` | 使用TCP模式 | `-t` |
| `--width` | 图像宽度 | `--width 640` |
| `--height` | 图像高度 | `--height 480` |
| `--fb-phys` | 帧缓冲物理地址 | `--fb-phys 0x20000000` |

---

## 常见问题排查

### 问题1：PC端收不到数据

**检查清单：**

- [ ] PC端接收程序是否**先于**发送程序启动？
- [ ] 网络是否连通？（能互相ping通吗？）
- [ ] IP地址是否正确？
- [ ] 端口是否一致？（两端都是5000）
- [ ] 防火墙是否阻止了端口？

**Windows防火墙设置：**
1. 打开 "Windows Defender 防火墙"
2. 点击 "高级设置"
3. 点击 "入站规则" → "新建规则"
4. 选择 "端口" → "UDP" → "特定本地端口: 5000"
5. 选择 "允许连接"
6. 完成

**Linux防火墙设置：**
```bash
sudo ufw allow 5000/udp
sudo ufw allow 5000/tcp
```

---

### 问题2：视频画面卡顿

**可能原因：**
- 网络带宽不足（需要约600Mbps）
- 使用的是百兆网口

**解决方法：**
1. 确保使用千兆网口和千兆网线
2. 避免使用WiFi
3. 关闭其他占用网络的程序

**检查网口速度：**
```bash
# Linux
ethtool eth0 | grep Speed

# 应该显示: Speed: 1000Mb/s
```

---

### 问题3：UDP模式丢帧

**增加系统缓冲区（Linux PC）：**
```bash
sudo sysctl -w net.core.rmem_max=8388608
sudo sysctl -w net.core.rmem_default=8388608
```

**或切换到TCP模式：**
```bash
# PC端
python receive_stream.py -p 5000 -t

# 开发板端
sudo ./run_network_stream.sh 10.72.43.200 5000 tcp
```

---

### 问题4：OpenCV未安装

**错误信息：**
```
警告: 未安装OpenCV，将只显示统计信息
```

**解决方法：**
```bash
pip install opencv-python numpy

# 如果失败，尝试：
pip3 install opencv-python numpy

# 或使用国内镜像：
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple opencv-python numpy
```

---

### 问题5：开发板程序启动失败

**错误：VDMA初始化失败**

这通常意味着硬件未正确配置。请检查：
- 设备树是否正确
- FPGA比特流是否已加载
- UIO设备是否存在

```bash
# 检查UIO设备
ls /dev/uio*

# 检查设备树
cat /proc/device-tree/axi/*vdma*/compatible
```

---

## 快速参考卡片

```
┌────────────────────────────────────────────────────────────────┐
│                    网络传输快速参考                              │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  【开发板IP配置】                                               │
│  $ ifconfig eth0 10.72.43.10 netmask 255.255.0.0 up           │
│                                                                │
│  【PC端 - 先启动】                                              │
│  $ python receive_stream.py -p 5000                            │
│                                                                │
│  【开发板 - 后启动】                                            │
│  $ sudo ./run_network_stream.sh 10.72.43.200                   │
│                                                                │
│  【退出】按 'q' 键                                              │
│                                                                │
├────────────────────────────────────────────────────────────────┤
│  TCP模式：两端都加 -t 参数                                       │
│  保存视频：PC端加 -o video.avi                                   │
│  改端口：两端都加 -p <端口号>                                     │
└────────────────────────────────────────────────────────────────┘
```

---

## 技术规格

| 项目 | 规格 |
|------|------|
| 视频格式 | YUV422 (YUYV) 16-bit/像素 |
| 分辨率 | 640 × 480 |
| 帧率 | 60 fps |
| 单帧大小 | 614,400 bytes (0.59 MB) |
| 理论带宽 | 36.9 MB/s ≈ 295 Mbps |
| 推荐网络 | 千兆以太网 (1 Gbps) |
| 协议选择 | UDP（低延迟）/ TCP（可靠）|

---

*文档版本: v1.0*
*更新日期: 2024年12月*
